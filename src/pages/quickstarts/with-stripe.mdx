# Quickstart with Stripe

## Intro

Stripe is a payment processing platform. Use cases include:

- Monetizing access to expensive API calls
- Monetizing premium extension feature
- Selling themes, merchs, physical and digital goods, etc...

## Scenario

You are a SaaS company looking to offer a premium API service to your customer via an extension. You would like your users to pay $5/month before the extension can access this premium feature.

## Setting Up a Stripe Product Link

Due to [Manifest v3's restriction with remote code execution](https://developer.chrome.com/docs/extensions/mv3/intro/mv3-overview/#remotely-hosted-code), there are limited options to have a PCI-compliant payment system integrated into an extension. The easiest way is to setup a Stripe Product Link.

To setup a Stripe Product Link, you will first need to create a Stripe product. Head to [Stripe Product Dashboard](https://dashboard.stripe.com/test/products?active=true) page, and press Add Product, then fill out the information:

![Stripe add Product](/screenshots/stripe-add-product.png)

Then, go to the product page and click the `Create payment link` button:

![Stripe create payment](/screenshots/stripe-create-payment.png)

Above should get you the the Stripe Payment Link. For backend authorization, head to the [Stripe Dashboard Home Page](https://dashboard.stripe.com/test/dashboard) for the Secret Key:

![Stripe dev keys](/screenshots/stripe-dev-keys.png)

## Using env variable

Assuming you have setup a basic Plasmo project, the first thing to do is to setup our [environment variables](/workflows/env):

`.env.development`

```ini
PLASMO_PUBLIC_STRIPE_LINK=https://buy.stripe.com/test_XXXXXXXX

STRIPE_PRIVATE_API_KEY=sk_test_xxxxxxxxxxxxxxxxxxxxxx
```

To enable typescript intellisense, create an `index.d.ts` file:

`.index.d.ts`

```ts
declare namespace NodeJS {
  interface ProcessEnv {
    PLASMO_PUBLIC_STRIPE_LINK?: string

    STRIPE_PRIVATE_KEY?: string

    OAUTH_CLIENT_ID?: string

    CRX_PUBLIC_KEY?: string
    CRX_PRIVATE_KEY?: string
  }
}
```

## Accessing Chrome identity API

In order to associate a subscription with an user, we can use their email address. One quick way of doing so is to leverage the Chrome extension's [identity API](https://developer.chrome.com/docs/extensions/reference/identity). To prevent unauthorized access, we will need to setup OAuth2 authentication schema, which works as follow:

- Our extension generates an OAuth2 access token
- Extension sends request with the token to our backend
- Backend validates the tokens to get the user's email address
- Backend queries subscription status for the user

To enable the permission required for this feature, add the following to the `manifest` field of your `package.json` file:

```json
{
  ...
  "manifest": {
    ...
    "permissions": ["identity", "identity.email"]
  }
}
```

> **NOTE:** The `...` means if you have anything there already, preserve them as needed. You will see this in many of our code example.

Then, we will need to setup an OAuth2 client ID using Google Cloud Platform (GCP). Quickly create a new project in GCP following [this guide](https://cloud.google.com/resource-manager/docs/creating-managing-projects), then navigate to the Credentials page: `https://console.cloud.google.com/apis/credentials?referrer=search&project=<YOUR_PROJECT_ID>`. You will be presented with something like this:

![GCP Credential Page](/screenshots/2022-06-10-14-10-33.png)

Press `CREATE CREDENTIALS`, then select `OAuth client ID`:

![Create OAuth ClientID](/screenshots/2022-06-10-14-11-50.png)

On the next page, pick `Chrome app`. The form will then ask for an `Application ID`:

![Create Chrome App ClientID](/screenshots/2022-06-10-14-13-21.png)

This will be your Extension ID - the next section is about how to obtain it.

### Setup fixed Extension ID for development

You will want to ensure your extension ID is fixed for development. The reason being if you accidentally remove your development extension from your browser, the extension ID will be lost and your OAuth2 client will be invalidated.

Since Chromium derives the extension ID from a public key it generated, you can fixtate the extension ID by generating your own `key` instead. This key can be specified in the [`manifest` override of your `package.json`](customization#overriding-the-manifest). We can generate this key by following this [Stack Overflow answer](https://stackoverflow.com/a/46739698):

1. Generate the private key:

```sh
openssl genrsa 2048 | openssl pkcs8 -topk8 -nocrypt -out key.pem
```

2. Generate the public key from the private key above:

```sh
openssl rsa -in key.pem -pubout -outform DER | openssl base64 -A
```

We can leverage [env variable in our manifest overide](/workflows/env#using-env-in-manifest-overrides):

`.env.development`

```ini
...
CRX_PUBLIC_KEY=v47xxx
```

`package.json`

```json
{
  "manifest": {
    ...
    "key": "$CRX_PUBLIC_KEY"
  }
}
```

[Run the development server](/workflows#run-the-development-server) then [load the extension into your browser](/workflows#loading-the-extension). Then, copy the extension ID:

![Copy extension ID](/screenshots/2022-06-10-14-19-49.png)

Paste the ID into the OAuth form's Application ID field, then submit. You will then receive your OAuth2 client ID:

![OAuth Client ID](/screenshots/2022-06-10-14-36-19.png)

Add it to your environment variables:

`.env.development`

```ini
...
OAUTH_CLIENT_ID=<YOUR_OAUTH_CLIENT_ID>
```

And use it in our manifest overide:

`package.json`

```json
{
  ...
  "manifest": {
    ...
    "oauth2": {
      "client_id": "$OAUTH_CLIENT_ID",
      "scopes": [
       "https://www.googleapis.com/auth/userinfo.email",
       "https://www.googleapis.com/auth/userinfo.profile"
      ]
    }
  }
}
```

We are now ready to generate an OAuth access token to authorize and process the user's subscription!

## Integrating the Stripe Link into the Popup page

To streamline the Stripe payment link with the identity API, we can prefill the email on the Stripe hosted form via their exposed parameters:

```tsx
import { useEffect, useState } from "react"

function IndexPopup() {
  const [userInfo, setUserInfo] = useState<chrome.identity.UserInfo>(null)

  useEffect(() => {
    chrome.identity.getProfileUserInfo((data) => {
      if (data.email && data.id) {
        setUserInfo(data)
      }
    })
  }, [])

  return (
    <div
      style={{
        display: "flex",
        flexDirection: "column",
        padding: 16
      }}>
      Your email is: <b>{userInfo?.email}</b>
      <button
        disabled={!userInfo}
        onClick={() => {
          window.open(
            `${process.env.PLASMO_PUBLIC_STRIPE_LINK}?client_reference_id=${
              userInfo.id
            }&prefilled_email=${encodeURIComponent(userInfo.email)}`,
            "_blank"
          )
        }}>
        Subscribe to Paid feature
      </button>
    </div>
  )
}

export default IndexPopup
```

## Verify the subscription and enable premium feature

To verify the user's subscription, we will now set up our backend. This process can be simplified by leveraging [NextJS interopability with Plasmo](/quickstarts/with-nextjs). We will first install and configure [NextJS]:

## Full Example

For the complete example, check out [with-stripe](https://github.com/PlasmoHQ/examples/tree/main/with-stripe) in the examples GitHub repository.
